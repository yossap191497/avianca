
-- Yohana cano hernandez
-- Victor Galvis Zuleta
-- Yerson Ossa Patiño 


-- a) Los directores de tecnología desean saber el estado de un avión, los posibles estados son (Vuelo, Tierra, Mantenimiento,
--    Reparación), para esto se pide agregar una nueva columna enla tabla donde se almacena la información de los aviones

-- b) También desean conocer el aeropuerto dónde se encuentra actualmente, si el avión está en vuelo debe registrarse el 
--    aeropuerto desde donde despegó y cuando aterriza, se actualiza esta información. Si el avión está en mantenimiento
--    o en reparación debe registrar el aeropuerto donde se esté realizando esa operación (Usualmente El Dorado)

CREATE TABLE AVIONES 
( 
  ID INTEGER NOT NULL PRIMARY KEY
, MATRICULA VARCHAR2(255) NOT NULL
, ESTADO VARCHAR2(255) NOT NULL CHECK (ESTADO IN('VUELO', 'TIERRA', 'MANTENIMIENTO', 'REPARACIÓN'))
, SERIAL VARCHAR2(255) NOT NULL 
, EDAD VARCHAR2(255) NOT NULL 
, MODELO VARCHAR2(255) NOT NULL 
, MARCA VARCHAR2(255) NOT NULL CHECK (MARCA IN ('AIRBUS', 'ATR', 'BOEING', 'EMBRAER'))
, NUMERO_ASIENTOS_EJECUTIVA INTEGER NOT NULL
, NUMERO_ASIENTOS_ECONOMICA INTEGER NOT NULL
, AEROPUERTO_ID INTEGER NOT NULL CONSTRAINT FK_AVION_AEROPUERTO REFERENCES AEROPUERTOS(ID) 
);

SELECT * FROM AVIONES;

-- c) Asimismo se desea conocer el estado de los vuelos confirmados, los posibles estados son (en vuelo, cancelado, retrasado, confirmado, 
--    abordando, programado).

CREATE TABLE VUELOS 
(
  ID INTEGER PRIMARY KEY NOT NULL 
, FECHA_HORA_ESTIMADA_SALIDA TIMESTAMP NOT NULL 
, FECHA_HORA_ESTIMADA_LLEGADA TIMESTAMP NOT NULL 
, FECHA_HORA_REAL_SALIDA TIMESTAMP NOT NULL 
, FECHA_HORA_REAL_LLEGADA TIMESTAMP NOT NULL 
, DURACION_REAL TIMESTAMP NOT NULL 
, ESTADO VARCHAR(255) CHECK (ESTADO IN('EN VUELO', 'CANCELADO', 'RETRASADO','CONFIRMADO', 'ABORDANDO', 'PROGRAMADO'))
, CANTIDAD_PASAJEROS_EJECUTIVA INTEGER NOT NULL
, CANTIDAD_PASAJEROS_ECONOMICA INTEGER NOT NULL
, CONFIRMACION_VUELO NUMBER(1) NOT NULL CHECK(CONFIRMACION_VUELO IN (0, 1))
, PILOTO_COPILOTO_ID INTEGER NOT NULL CONSTRAINT FK_VUELO_PILOTO_COPILOTO REFERENCES PILOTOS(ID)
, PILOTO_ID INTEGER NOT NULL CONSTRAINT FK_VUELO_PILOTO REFERENCES PILOTOS(ID)
, AVION_ID INTEGER NOT NULL CONSTRAINT FK_VUELO_AVION REFERENCES AVIONES(ID)
, PROGRAMACION_ID INTEGER NOT NULL CONSTRAINT FK_VUELO_PROGRAMACION REFERENCES PROGRAMACIONES(ID)
);

SELECT * FROM VUELOS;

-- 1) Se desea asignar un avión a un vuelo confirmado, para esto es necesario una vista que dado el id de un vuelo confirmado,
--    busque los aviones que se encuentran en el aeropuerto de salida (Utilizando la hora estimada de llegada a esa 
--    ciudad / aeropuerto de otros vuelos) 2 horas antes de la fecha estimada de salida.

CREATE OR REPLACE VIEW AEROPUERTOS_DEL_VUELO AS
SELECT V.ID, V.FECHA_HORA_ESTIMADA_SALIDA AS SALIDA, R.AEROPUERTO_DESTINO_ID, R.AEROPUERTO_ORIGEN_ID
    FROM VUELOS V
        INNER JOIN PROGRAMACIONES P ON V.PROGRAMACION_ID = P.ID
        INNER JOIN RUTAS R ON P.RUTA_ID = R.ID
        WHERE V.ESTADO = 'PROGRAMADO'
        ORDER BY SALIDA;

CREATE OR REPLACE VIEW DISPONIBILIDAD_AVIONES AS
SELECT VU.ID AS VUELO_ID, AV.ID, (AV.NUMERO_ASIENTOS_ECONOMICA + AV.NUMERO_ASIENTOS_EJECUTIVA) AS NUMERO_ASIENTOS,
	AV.MATRICULA, AV.ESTADO, VU.FECHA_HORA_ESTIMADA_LLEGADA, V.SALIDA AS SALIDA_VUELO_CONFIRMADO,
(V.SALIDA + INTERVAL '-2' HOUR ) AS RESTA, V.ID AS VUELO_PROGRAMADO
    FROM VUELOS VU
        INNER JOIN PROGRAMACIONES PR On VU.Programacion_Id = PR.ID
        INNER JOIN RUTAS RU On PR.RUTA_ID = RU.ID
        INNER JOIN AVIONES AV  ON AV.ID = VU.AVION_ID
        INNER JOIN AEROPUERTOS_DEL_VUELO V ON RU.AEROPUERTO_DESTINO_ID = V.AEROPUERTO_ORIGEN_ID
        WHERE  VU.FECHA_HORA_ESTIMADA_LLEGADA < (V.SALIDA + INTERVAL '-2' HOUR ) AND VU.ESTADO = 'EN VUELO';
        
-- * IMPLEMENTACIÓN DE LA VISTA QUE DEVUELVE LOS AVIONES QUE PUEDEN SER ASIGNADOS A UN VUELO
SELECT * FROM DISPONIBILIDAD_AVIONES 
WHERE VUELO_PROGRAMADO = 28;



-- 2) Realice un procedimiento almacenado que programe la tripulación del vuelo 5 horas antes del vuelo
--    a) Invocar la vista del punto dos y asignar el primer avión encontrado.
--    b) Con la información del vuelo debe asignar:
--       i) El piloto y el copiloto:
--          (1) Para la simplicidad del ejercicio, busque los pilotos que se encuentran activos, tienen al menos 2 horas de
--              descanso y se encuentran en la ciudad donde parte el vuelo.
--      ii) La tripulación siguiendo la lógica del taller anterior dependiendo del número de horas del vuelo programado y la
--          cantidad de sillas del avión.
--          (1) También por simplicidad del ejercicio se debe buscar los auxiliares de vuelo que tienen al menos 2 horas de
--              descanso, que estén activos y que se encuentren en la ciudad donde parte el vuelo.
--    c) Actualizar el estado del vuelo a “Confirmado”

-- VISTAS IMPLEMENTADAS EN EL PROCEDIMIENTO ALMACENADO

CREATE OR REPLACE VIEW GETPILOTOS
AS
    SELECT P.ID ,TO_CHAR(E.HORAS_DESCANSO,'HH24:MI') AS HORAS_DESCANSO,E.CIUDAD_PAIS_ID AS CIUDAD
    FROM PILOTOS  P
    INNER JOIN EMPLEADOS E ON P.EMPLEADO_ID = E.ID
    WHERE TO_TIMESTAMP(TO_CHAR(E.HORAS_DESCANSO,'HH24:MI'),'HH24:MI') >= TO_TIMESTAMP('02:00','HH24:MI') 
    AND ESTADO = 'ACTIVO'; 
    
CREATE OR REPLACE VIEW GET_AUXILIARES
AS
    SELECT E.ID ,TO_CHAR(E.HORAS_DESCANSO,'HH24:MI') AS HORAS_DESCANSO,E.CIUDAD_PAIS_ID AS CIUDAD
    FROM EMPLEADOS E 
    WHERE TO_TIMESTAMP(TO_CHAR(E.HORAS_DESCANSO,'HH24:MI'),'HH24:MI') >= TO_TIMESTAMP('02:00','HH24:MI') 
    AND E.ESTADO = 'ACTIVO' AND E.TIPO_EMPLEADO = 'AUXILIAR DE VUELO'; 


CREATE OR REPLACE PROCEDURE  ASIGNAR_TRIPULACION(vuelo IN NUMBER)
AS
avion_id NUMBER := 0;
ciudad_id NUMBER :=0;
CANTIDAD_HORAS_VUELO RUTAS.CANTIDAD_HORAS_PROMEDIO%TYPE;
NUMEROASIENTOS NUMBER := 0;
NUMERO_AUXILIARES NUMBER := 0;
ID_EMPLEADO NUMBER :=0;
DURACION TIMESTAMP;
E_ID_PILOTO NUMBER :=0;
E_ID_COPILOTO NUMBER :=0;
CURSOR Cp1
   IS
     SELECT ID 
    FROM GETPILOTOS 
    WHERE CIUDAD = ciudad_id AND ROWNUM <=2;
CURSOR CAux
   IS
     SELECT ID 
    FROM GET_AUXILIARES 
    WHERE CIUDAD = ciudad_id AND ROWNUM <=NUMERO_AUXILIARES;
BEGIN 
--selecionar el avion
   SELECT ID,NUMERO_ASIENTOS INTO avion_id,NUMEROASIENTOS
	FROM DISPONIBILIDAD_AVIONES
	WHERE VUELO_PROGRAMADO = vuelo AND rownum = 1;
    DBMS_OUTPUT.PUT_LINE('avion seleccionado '||avion_id);
    
    --DURACION Y CIUDAD_ID
    SELECT SUBSTR(R.CANTIDAD_HORAS_PROMEDIO,12),AE.CIUDAD_PAIS_ID INTO CANTIDAD_HORAS_VUELO ,ciudad_id
        FROM VUELOS V
            INNER JOIN PROGRAMACIONES P ON V.PROGRAMACION_ID = P.ID
            INNER JOIN RUTAS R ON P.RUTA_ID = R.ID
            INNER JOIN AEROPUERTOS AE ON R.AEROPUERTO_ORIGEN_ID = AE.ID
        WHERE V.ID = vuelo;
    DBMS_OUTPUT.PUT_LINE('CANTIDAD_HORAS_PROMEDIO '|| CANTIDAD_HORAS_VUELO);
        DBMS_OUTPUT.PUT_LINE('CIUDAD '|| ciudad_id);
    
    OPEN Cp1;
    FETCH Cp1 INTO E_ID_PILOTO;
    DBMS_OUTPUT.PUT_LINE('Piloto seleccionado '||E_ID_PILOTO);
    FETCH Cp1 INTO E_ID_COPILOTO;
    DBMS_OUTPUT.PUT_LINE('Copiloto seleccionado '||E_ID_COPILOTO);
    close Cp1;
    IF( E_ID_PILOTO=0 OR E_ID_COPILOTO=0) THEN 
        DBMS_OUTPUT.PUT_LINE('NO HAY PILOTOS Y/O COPILOTOS POR ASIGNAR '|| NUMEROASIENTOS);
        RETURN;
    END IF;
    DBMS_OUTPUT.PUT_LINE('ASIENTOS '|| NUMEROASIENTOS);
    
   
    IF NUMEROASIENTOS > 19 AND NUMEROASIENTOS < 50 THEN
      NUMERO_AUXILIARES := 1;
    ELSIF NUMEROASIENTOS >= 50  THEN
      NUMERO_AUXILIARES := 2 + FLOOR((NUMEROASIENTOS - 50)/50);
    END IF;
    
    
    --PONER EL DOBLE DEL PERSONAL SI ES MAYOR LA DURACION DEL VUELO ES MAYOR A 6 HORAS
    IF(TO_TIMESTAMP(CANTIDAD_HORAS_VUELO,'HH24:MI:SS')> TO_TIMESTAMP('06:00','HH24:MI') ) THEN
        NUMERO_AUXILIARES:= NUMERO_AUXILIARES*2;        
    END IF;
    DBMS_OUTPUT.PUT_LINE('NUMERO_AUXILIARES '|| NUMERO_AUXILIARES);
-- asignar tripulacion
    OPEN CAux;
    LOOP
    FETCH CAux INTO ID_EMPLEADO; 
      EXIT WHEN CAux%notfound;
      DBMS_OUTPUT.PUT_LINE('Se programo el Empleado: ' || ID_EMPLEADO || ', al vuelo ID: ' || vuelo);
      
-- INGRESO DE LOS AUXILIARES
      INSERT INTO AUXILIARES_VUELOS (ID,EMPLEADO_ID,VUELO_ID) 
      VALUES(SEC_AUXILIARES_VUELOS.NEXTVAL,ID_EMPLEADO,vuelo);
    END LOOP;
    CLOSE CAux;

-- Actualizo el campo Aeronave_ID en la tabla de programaciones para indicar cual es el avion asignado y cambio el estado de programacion a 'Confirmado'
    UPDATE VUELOS 
    SET AVION_ID = avion_id , ESTADO = 'CONFIRMADO', CONFIRMACION_VUELO = 1,
    PILOTO_ID = E_ID_PILOTO,PILOTO_COPILOTO_ID = E_ID_COPILOTO
    WHERE ID = vuelo;
    
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        IF(avion_id <= 0 ) THEN
            DBMS_OUTPUT.PUT_LINE('NO HAY AVIONES DISPONIBLES');
            RETURN;
        END IF; 
        IF(E_ID_PILOTO <= 0 ) THEN
            DBMS_OUTPUT.PUT_LINE('NO HAY PILOTOS DISPONIBLES');
            RETURN;
        END IF;
        IF(E_ID_COPILOTO <= 0 ) THEN
            DBMS_OUTPUT.PUT_LINE('NO HAY COPILOTOS DISPONIBLES');
            RETURN;
        END IF;

        WHEN OTHERS THEN
        	DBMS_OUTPUT.PUT_LINE('ERROR');
END;

-- IMPLEMENTACION

BEGIN
ASIGNAR_TRIPULACION(28);
END;



-- 3) Construya un procedimiento que permita hacer el checking de los pasajeros, para esto se debe pasar el id del vuelo
--    confirmado, el id del pasajero y el tipo de silla que tiene (Ejecutiva, Económica).
--    a) Por cada checking exitoso actualice la cantidad de pasajeros en la tabla del vuelo confirmado dependiendo de la
--       silla que tenga.
--    b) Se debe validar que la cantidad de pasajeros no supere la cantidad de sillas del avión asignado. En caso de ser
--       superior el procedimiento simplemente se ejecutará pero no mostrará ningún error y tampoco modificará las tablas
--       existentes.

CREATE OR REPLACE PROCEDURE ASIGNAR_CHECK_IN_PASAJERO(ID_VUELO IN NUMBER, ID_PASAJERO IN NUMBER, 
TIPO_CHECK_IN IN VARCHAR2, NOMBRE_CONTACTO_EMERGENCIA IN VARCHAR2, CORREO_CONTACTO_EMERGENCIA IN VARCHAR2, 
TELEFONO_CONTACTO_EMERGENCIA IN VARCHAR2, CLASE_VUELO IN VARCHAR2, ID_CIUDAD_PAIS IN NUMBER) AS

-- Declaración de variables
VALIDAR_VUELO NUMBER := 0;
VALIDAR_PASAJERO NUMBER := 0;
VALIDAR_VUELO_CONFIRMADO NUMBER := 0;
VALIDAR_CUIDAD_PAIS NUMBER := 0;

CAPACIDAD_ASIENTOS_EJE_AVION NUMBER := 0;
CAPACIDAD_ASIENTOS_ECO_AVION NUMBER := 0;
CANTIDAD_ASIENTOS_EJE_VUELO NUMBER := 0;
CANTIDAD_ASIENTOS_ECO_VUELO NUMBER := 0;
BEGIN 
-- Validar si el vuelo existe
    SELECT VU.ID, VU.CANTIDAD_PASAJEROS_EJECUTIVA, VU.CANTIDAD_PASAJEROS_ECONOMICA, AV.NUMERO_ASIENTOS_EJECUTIVA,
        AV.NUMERO_ASIENTOS_ECONOMICA
    INTO VALIDAR_VUELO,CANTIDAD_ASIENTOS_EJE_VUELO, CANTIDAD_ASIENTOS_ECO_VUELO, CAPACIDAD_ASIENTOS_EJE_AVION,
        CAPACIDAD_ASIENTOS_ECO_AVION
        FROM VUELOS VU
        INNER JOIN AVIONES AV ON VU.AVION_ID = AV.ID
        WHERE VU.ID = ID_VUELO AND VU.ESTADO = 'CONFIRMADO'
        AND ROWNUM = 1;
     
-- Validar si el pasajero existe
    SELECT ID INTO VALIDAR_PASAJERO FROM PASAJEROS WHERE ID = ID_PASAJERO AND ROWNUM = 1 ;
    
-- Validar si la ciudad y el país existe
    SELECT ID INTO VALIDAR_CUIDAD_PAIS FROM CIUDADES_PAISES WHERE ID = ID_CIUDAD_PAIS AND ROWNUM = 1 ;

-- Validar si tipo de check_in existe
    IF(TIPO_CHECK_IN <> 'FISICO' AND TIPO_CHECK_IN <> 'VIRTUAL') THEN
        DBMS_OUTPUT.PUT_LINE('EL TIPO DE CHECK_IN NO EXISTE');
        RETURN;
    END IF;
 
-- Validar si clase de vuelo existe (tipo de asiento)
    IF(CLASE_VUELO <> 'EJECUTIVA' AND CLASE_VUELO <> 'ECONOMICA') THEN
        DBMS_OUTPUT.PUT_LINE('EL TIPO DE ASIENTO NO EXISTE');
        RETURN;
    END IF;

-- Validar cantidad de asientos en el avión para la clase de vuelo Ejecutiva y actualizar el asiento en en vuelo recibido
    IF (CLASE_VUELO = 'EJECUTIVA') THEN
        IF (CAPACIDAD_ASIENTOS_EJE_AVION > CANTIDAD_ASIENTOS_EJE_VUELO) THEN
        
-- Insertar el pasajero en check_in
        INSERT INTO CHECK_IN (ID, TIPO, NUMERO_CONFIRMACION, NOMBRE_CONTACTO_EMERGENCIA, CORREO_CONTACTO_EMERGENCIA, 
            TELEFONO_CONTACTO_EMERGENCIA, CLASE_VUELO, CIUDAD_PAIS_ID, VUELO_ID, PASAJERO_ID) 
            VALUES (SEC_CHECK_IN.NEXTVAL, TIPO_CHECK_IN, SEC_CHECK_IN.NEXTVAL, NOMBRE_CONTACTO_EMERGENCIA, 
            CORREO_CONTACTO_EMERGENCIA,TELEFONO_CONTACTO_EMERGENCIA, CLASE_VUELO, ID_CIUDAD_PAIS, ID_VUELO, ID_PASAJERO);
            DBMS_OUTPUT.PUT_LINE('CHECK_IN CREADO');
            IF (SQL%FOUND = FALSE) THEN
            DBMS_OUTPUT.PUT_LINE('NO SE CREÓ CHECK_IN');
            RETURN;
            END IF;
    
        UPDATE VUELOS
            SET CANTIDAD_PASAJEROS_EJECUTIVA = CANTIDAD_PASAJEROS_EJECUTIVA + 1
            WHERE ID = ID_VUELO;
            DBMS_OUTPUT.PUT_LINE('ASIENTO EJECUTIVA ACTUALIZADA EN EL VUELO');
        ELSE
        DBMS_OUTPUT.PUT_LINE('EL AVIÓN EXCEDIÓ LA CANTIDAD DE ASIENTOS EJECUTIVOS');
        RETURN;
    END IF;
END IF;

-- Validar cantidad de asientos en el avión para la clase de vuelo Economico y actualizar el asiento en en vuelo recibido
    IF (CLASE_VUELO = 'ECONOMICA') THEN
        IF (CAPACIDAD_ASIENTOS_ECO_AVION > CANTIDAD_ASIENTOS_ECO_VUELO) THEN
        
-- Insertar el pasajero en check_in
        INSERT INTO CHECK_IN (ID, TIPO, NUMERO_CONFIRMACION, NOMBRE_CONTACTO_EMERGENCIA, CORREO_CONTACTO_EMERGENCIA, 
            TELEFONO_CONTACTO_EMERGENCIA, CLASE_VUELO, CIUDAD_PAIS_ID, VUELO_ID, PASAJERO_ID) 
            VALUES (SEC_CHECK_IN.NEXTVAL, TIPO_CHECK_IN, SEC_CHECK_IN.NEXTVAL, NOMBRE_CONTACTO_EMERGENCIA, 
            CORREO_CONTACTO_EMERGENCIA,TELEFONO_CONTACTO_EMERGENCIA, CLASE_VUELO, ID_CIUDAD_PAIS, ID_VUELO, ID_PASAJERO);
            DBMS_OUTPUT.PUT_LINE('CHECK_IN CREADO');
            IF (SQL%FOUND = FALSE) THEN
            DBMS_OUTPUT.PUT_LINE('NO SE CREÓ CHECK_IN');
            RETURN;
            END IF;
    
        UPDATE VUELOS
            SET CANTIDAD_PASAJEROS_ECONOMICA = CANTIDAD_PASAJEROS_ECONOMICA + 1
            WHERE ID = ID_VUELO;
            DBMS_OUTPUT.PUT_LINE('ASIENTO ECONOMICA ACTUALIZADA EN EL VUELO');
        ELSE
        DBMS_OUTPUT.PUT_LINE('EN AVIÓN EXCEDIÓ LA CANTIDAD DE ASIENTOS ECONÓMICOS');
        RETURN;
    END IF;
END IF;

EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        IF (VALIDAR_VUELO <= 0) THEN
            DBMS_OUTPUT.PUT_LINE('EL VUELO NO EXISTE');
            RETURN;
        END IF;
        IF (VALIDAR_PASAJERO <= 0) THEN
            DBMS_OUTPUT.PUT_LINE('EL PASAJERO NO EXISTE');
        RETURN;
        END IF;
        IF (VALIDAR_CUIDAD_PAIS <= 0) THEN
            DBMS_OUTPUT.PUT_LINE('LA CIUDAD Y EL PAÍS NO EXISTE');
        RETURN;
        END IF;
    WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('ERROR');
END;

-- IMPLEMENTACIÓN DEL PROCEDIMIENTO ASIGNAR_CHECK_IN_PASAJERO
BEGIN
ASIGNAR_CHECK_IN_PASAJERO(2, 33, 'FISICO', 'MATEO', 'MATEO@UNE.CO', '834 267 90 00','EJECUTIVA', 6);
END;


 SELECT VU.ID, VU.CANTIDAD_PASAJEROS_EJECUTIVA, VU.CANTIDAD_PASAJEROS_ECONOMICA, AV.NUMERO_ASIENTOS_EJECUTIVA,
        AV.NUMERO_ASIENTOS_ECONOMICA
        FROM VUELOS VU
        INNER JOIN AVIONES AV ON VU.AVION_ID = AV.ID
        WHERE VU.ID = 284 AND VU.ESTADO = 'CONFIRMADO'
        AND ROWNUM = 1;


-- 4) Construya una vista que dado un id de un vuelo pasado o confirmado, muestre el listado de personal asignado al vuelo,
--    tanto pilotos como auxiliares de vuelo). Debe haber una columna que identifique quien es el piloto, quién es el 
--    copiloto y quienes son los auxiliares de vuelo.

CREATE OR REPLACE VIEW TRIPULACION_DE_UN_VUELO AS
SELECT V.ID AS VUELO_ID, E.ID, (E.NOMBRES || ' ' || E.APELLIDOS) AS NOMBRE_COMPLETO,
(CASE WHEN P.ID = V.PILOTO_COPILOTO_ID THEN 'COPILOTO' ELSE 'PILOTO' END ) AS CARGO
    FROM VUELOS V
        INNER JOIN PILOTOS P ON V.PILOTO_ID = P.ID OR V.PILOTO_COPILOTO_ID = P.ID
        INNER JOIN EMPLEADOS E ON P.EMPLEADO_ID = E.ID
        WHERE V.CONFIRMACION_VUELO = 1
UNION
SELECT V.ID AS VUELO_ID, E.ID, (E.NOMBRES || ' ' || E.APELLIDOS) AS NOMBRE_COMPLETO, E.TIPO_EMPLEADO AS CARGO
    FROM VUELOS V
        INNER JOIN AUXILIARES_VUELOS  AUV ON V.ID = AUV.VUELO_ID
        INNER JOIN EMPLEADOS E ON AUV.EMPLEADO_ID = E.ID
        WHERE V.CONFIRMACION_VUELO = 1;

-- * IMPLEMENTACIÓN DE LA VISTA CON UN VUELO CONFIRMADO
SELECT * FROM TRIPULACION_DE_UN_VUELO 
    WHERE VUELO_ID = 28;

-- * IMPLEMENTACIÓN DE LA VISTA CON UN VUELO NO CONFIRMADO
SELECT * FROM TRIPULACION_DE_UN_VUELO 
    WHERE VUELO_ID = 11;

	
-- 5) Construya una vista que dado un aeropuerto origen y un aeropuerto destino (Ruta), muestre todos los vuelos programados
--    desde el momento en que se está ejecutando el query hasta 2 semanas después, debe mostrar el número del vuelo, la hora
--    y la fecha programada de salida.

CREATE OR REPLACE VIEW VUELOS_DE_RUTA AS
SELECT V.ID, 
	R.AEROPUERTO_ORIGEN_ID,
	(SELECT AEROPUERTOS.NOMBRE FROM AEROPUERTOS WHERE ID= R.AEROPUERTO_ORIGEN_ID)AS AEROPUERTO_ORIGEN,
	R.AEROPUERTO_DESTINO_ID,
	(SELECT AEROPUERTOS.NOMBRE FROM AEROPUERTOS WHERE ID= R.AEROPUERTO_DESTINO_ID)AS AEROPUERTO_DESTINO,
	P.NUMERO_VUELO, V.FECHA_HORA_ESTIMADA_SALIDA
	FROM VUELOS V
		INNER JOIN PROGRAMACIONES P ON V.PROGRAMACION_ID = P.ID
		INNER JOIN RUTAS R ON P.RUTA_ID = R.ID
		WHERE  V.FECHA_HORA_ESTIMADA_SALIDA>SYSDATE AND V.FECHA_HORA_ESTIMADA_SALIDA<(SYSDATE +INTERVAL '14' DAY) 
		ORDER BY V.FECHA_HORA_ESTIMADA_SALIDA;

-- * IMPLEMENTACIÓN DE LA VISTA CON LOS AEROPUERTOS DE UNA RUTA
SELECT * FROM VUELOS_DE_RUTA 
	WHERE AEROPUERTO_ORIGEN_ID = 30 AND AEROPUERTO_DESTINO_ID = 38;
		
		
-- 6) Realizar un EXPLAIN PLAN de las vistas en los puntos 1, 4 y 5.

--    * EXPLAIN PLAN VISTA DEL PUNTO 1
EXPLAIN PLAN SET STATEMENT_ID = 'PLAN_DISPONIBILIDAD_AVIONES' FOR 
SELECT * FROM DISPONIBILIDAD_AVIONES;

SELECT * FROM TABLE (DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'PLAN_DISPONIBILIDAD_AVIONES', 'TYPICAL'));


--    * EXPLAIN PLAN VISTA DEL PUNTO 4
EXPLAIN PLAN SET STATEMENT_ID = 'PLAN_TRIPULACION_DE_UN_VUELO' FOR 
SELECT * FROM TRIPULACION_DE_UN_VUELO;

SELECT * FROM TABLE (DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'PLAN_TRIPULACION_DE_UN_VUELO', 'TYPICAL'));

--    * EXPLAIN PLAN VISTA DEL PUNTO 5
EXPLAIN PLAN SET STATEMENT_ID = 'PLAN_VUELOS_DE_RUTA' FOR 
SELECT * FROM VUELOS_DE_RUTA;

SELECT * FROM TABLE (DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'PLAN_VUELOS_DE_RUTA', 'TYPICAL'));


-- 7) Leer los siguientes artículos / ver el siguiente video. Para cada video se debe narrar el contenido de cada lectura,
--	  se debe hacer una opinión crítica, como si usted le estuviera contando a alguien que no sabe de la materia sin dejar
--    de lado la terminología técnica.
--    a) Why Uber Engineering Switched from Postgres to MySQL (Victor)
--    b) Oracle Sharding Overview (Yerson)
--    c) Netflix: What Happens When You Press Play? (Yohana)

